# Решение проблемы FMP API 403 Forbidden

## Проблема

В логах Railway видны ошибки:
```
FMP profile batch error 403
FMP profile batch error 403
```

**403 Forbidden** означает, что FMP API отклоняет запросы. Это может быть из-за:

1. **Неверный или истекший API ключ**
2. **Превышен лимит запросов** (rate limit)
3. **API ключ не имеет доступа к нужным эндпоинтам**
4. **Тарифный план не поддерживает нужные функции**

## Решение

### Шаг 1: Проверьте API ключ в Railway

1. Зайдите в Railway Dashboard
2. Откройте ваш сервис
3. Перейдите в **Settings → Environment Variables**
4. Найдите переменную `FMP_API_KEY`
5. Убедитесь, что:
   - Ключ существует
   - Ключ скопирован полностью (без пробелов в начале/конце)
   - Ключ правильный (проверьте в FMP Dashboard)

### Шаг 2: Проверьте статус API ключа в FMP Dashboard

1. Зайдите на https://financialmodelingprep.com/
2. Войдите в аккаунт
3. Перейдите в **Dashboard → API Keys**
4. Проверьте:
   - **Статус ключа** - должен быть "Active"
   - **Expiration Date** - ключ не должен быть истекшим
   - **Rate Limits** - проверьте, не превышен ли лимит

### Шаг 3: Проверьте тарифный план

Убедитесь, что ваш тарифный план FMP поддерживает:
- **Quote endpoint** (`/api/v3/quote/`)
- **Profile endpoint** (`/api/v3/profile/`)

Некоторые бесплатные планы могут иметь ограничения.

### Шаг 4: Проверьте лимиты запросов

В FMP Dashboard проверьте:
- **Daily API Calls** - сколько запросов использовано сегодня
- **Monthly API Calls** - сколько запросов использовано в этом месяце
- **Rate Limit** - сколько запросов в минуту/час разрешено

Если лимиты превышены:
- Подождите до сброса лимита (обычно в полночь UTC)
- Или обновите тарифный план

### Шаг 5: Протестируйте API ключ вручную

Попробуйте сделать запрос напрямую:

```bash
# Замените YOUR_API_KEY на ваш ключ
curl "https://financialmodelingprep.com/api/v3/quote/AAPL?apikey=YOUR_API_KEY"
```

**Ожидаемый ответ:**
```json
[{
  "symbol": "AAPL",
  "name": "Apple Inc.",
  "price": 150.25,
  ...
}]
```

**Если получаете ошибку:**
- `{"Error Message": "Invalid API Key"}` - ключ неверный
- `{"Error Message": "Limit Reached"}` - превышен лимит
- `403 Forbidden` - проблема с доступом или тарифом

### Шаг 6: Обновите API ключ в Railway

Если ключ неверный или истек:

1. Получите новый ключ в FMP Dashboard
2. В Railway → Settings → Environment Variables
3. Обновите значение `FMP_API_KEY`
4. **Перезапустите сервис** в Railway (важно!)

### Шаг 7: Проверьте логи после исправления

После обновления ключа и перезапуска, проверьте логи Railway:

**Хорошие сообщения:**
```
[Scheduler] Started 7 cron jobs
[Scheduler] Run: hourly prices update
```

**Плохие сообщения (если все еще есть):**
```
[FMP] 403 Forbidden - Check API key validity
[FMP] FMP_API_KEY is missing or empty
```

## Дополнительная диагностика

### Проверка через API эндпоинт

Попробуйте вручную запустить обновление цен:

```bash
# Замените на ваш Railway URL
curl -X POST https://your-app.railway.app/api/prices/update-all
```

Проверьте ответ и логи Railway.

### Мониторинг использования API

В FMP Dashboard можно увидеть:
- Количество запросов за день/месяц
- Какие эндпоинты используются
- Когда был последний запрос

## Если проблема не решается

1. **Свяжитесь с поддержкой FMP** - возможно, проблема на их стороне
2. **Проверьте, не заблокирован ли ваш IP** - некоторые платформы блокируют определенные IP
3. **Попробуйте другой API ключ** - создайте новый ключ в FMP Dashboard
4. **Проверьте тарифный план** - возможно, нужен более высокий тариф

## Улучшения в коде

Код был обновлен для лучшей диагностики:
- Более информативные сообщения об ошибках
- Проверка наличия API ключа перед запросами
- Детальные логи для 403 ошибок

После исправления проблемы, ошибки должны исчезнуть из логов.
