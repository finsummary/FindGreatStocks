# Объяснение: Почему колонки roic_stability, roic_stability_score, fcf_margin не были добавлены раньше?

## Как работают эти метрики для существующих компаний

### 1. **roicStability** и **roicStabilityScore**

Для **всех существующих компаний** эти значения **вычисляются динамически в UI** (в браузере), а не хранятся в базе данных.

**Код в `company-table.tsx` (строки 912-915, 920):**
```typescript
const avg = c.roic10YAvg != null ? Number(c.roic10YAvg) : null;
const std = c.roic10YStd != null ? Number(c.roic10YStd) : null;
const ratio = (avg !== null && std !== null && isFinite(std) && std > 0) ? (avg / std) : null;
const score = (ratio != null) ? Math.min(100, Math.max(0, ratio * 30)) : null;
return { ...c, roicStability: ratio, roicStabilityScore: score, ... };
```

**Формулы:**
- `roicStability = roic10YAvg / roic10YStd`
- `roicStabilityScore = min(100, roicStability × 30)`

### 2. **fcfMargin**

Также вычисляется динамически в UI:
```typescript
const revenue = c.revenue != null ? Number(c.revenue) : null;
const fcf = c.freeCashFlow != null ? Number(c.freeCashFlow) : null;
const fcfMargin = (revenue !== null && revenue !== 0 && fcf != null) ? (fcf / revenue) : null;
```

**Формула:** `fcfMargin = freeCashFlow / revenue`

## Почему колонки не были добавлены раньше?

1. **Не было необходимости** - значения вычислялись динамически в UI из существующих данных (`roic10YAvg`, `roic10YStd`, `freeCashFlow`, `revenue`)

2. **Производительность** - вычисление в UI достаточно быстрое для отображения

3. **Гибкость** - можно было изменить формулы без миграции БД

## Почему мы добавили их сейчас?

1. **Для новых компаний (CVNA, CRH, FIX)** - нужно сохранять эти значения в БД сразу при заполнении данных, чтобы они были доступны сразу после скрипта

2. **Консистентность** - если значения вычисляются и сохраняются в скрипте, они должны быть доступны в БД

3. **Производительность** - если значения уже вычислены, лучше использовать их из БД, чем вычислять заново

## Как это работает сейчас?

### Для существующих компаний:
- Значения вычисляются динамически в UI (как раньше)
- Если значения есть в БД - они используются (приоритет БД)
- Если значений нет в БД - вычисляются динамически

### Для новых компаний:
- Значения вычисляются в скрипте `populate-new-sp500-companies.ts`
- Сохраняются в БД в колонках `roic_stability`, `roic_stability_score`, `fcf_margin`
- Отображаются из БД в UI

## Вывод

**Колонки не были добавлены раньше, потому что они не были нужны** - все значения вычислялись динамически в UI. Мы добавили их сейчас для новых компаний, чтобы сохранять вычисленные значения в БД для консистентности и производительности.

Для существующих компаний ничего не изменилось - они продолжают работать как раньше (динамическое вычисление в UI).

