# Диагностика проблем с обновлением цен

## Возможные причины, почему цены не обновляются:

### 1. Проблема с планировщиком (Scheduler)

**Проблема:** В `index.js` планировщик создавался неправильно и не запускался.

**Исправление:** ✅ Исправлено - теперь планировщик правильно инициализируется и запускается.

**Проверка:**
- Проверьте логи Railway - должны быть сообщения `[Scheduler] Started X cron jobs`
- Планировщик запускается каждый час на 15-й минуте (например, 10:15, 11:15, 12:15 UTC)
- Также есть ночные обновления в 05:00 и 06:00 UTC

### 2. Отсутствие или неправильный FMP API ключ

**Проверка:**
1. Убедитесь, что в Railway есть переменная окружения `FMP_API_KEY`
2. Проверьте, что ключ правильный и активный
3. Проверьте лимиты API - возможно, превышен лимит запросов

**Как проверить:**
```bash
# В Railway logs должны быть ошибки типа:
# "FMP_API_KEY missing" или "FMP error"
```

### 3. Проблемы с API Financial Modeling Prep

**Возможные причины:**
- Превышен лимит запросов (rate limit)
- API ключ истек или неактивен
- Проблемы на стороне FMP API

**Как проверить:**
- Зайдите в Financial Modeling Prep Dashboard
- Проверьте статус API ключа
- Проверьте количество использованных запросов

### 4. Проблемы с базой данных

**Проверка:**
- Убедитесь, что `last_price_update` колонка существует (миграция применена)
- Проверьте, что Supabase доступен и работает
- Проверьте права доступа к таблицам

### 5. Проблемы с эндпоинтами

**Проверка:**
Попробуйте вручную вызвать эндпоинт обновления цен:

```bash
# Для S&P 500
curl -X POST https://your-railway-domain.railway.app/api/sp500/update-prices

# Для всех таблиц
curl -X POST https://your-railway-domain.railway.app/api/prices/update-all
```

**Ожидаемый ответ:**
```json
{"status": "started"}
```

### 6. Проверка последнего обновления

**Используйте эндпоинт:**
```bash
curl https://your-railway-domain.railway.app/api/prices/last-updated
```

**Ожидаемый ответ:**
```json
{
  "status": "recent",
  "lastUpdate": "2024-01-15T10:15:00Z",
  "message": "Prices were updated 2 hours ago",
  "hoursAgo": "2.0",
  "daysAgo": "0.1"
}
```

## Пошаговая диагностика:

### Шаг 1: Проверьте логи Railway

1. Зайдите в Railway Dashboard
2. Откройте ваш сервис
3. Перейдите в раздел "Logs"
4. Ищите сообщения:
   - `[Scheduler] Started X cron jobs` - планировщик запущен
   - `[Scheduler] Run: hourly prices update` - задача запущена
   - `FMP_API_KEY missing` - проблема с API ключом
   - `bulk update chunk error` - ошибки при обновлении

### Шаг 2: Проверьте переменные окружения в Railway

Убедитесь, что есть:
- `FMP_API_KEY` - ключ API Financial Modeling Prep
- `SUPABASE_URL` - URL вашей Supabase базы
- `SUPABASE_SERVICE_ROLE_KEY` - Service Role ключ Supabase

### Шаг 3: Проверьте статус API ключа FMP

1. Зайдите на https://financialmodelingprep.com/
2. Войдите в аккаунт
3. Проверьте статус API ключа
4. Проверьте лимиты запросов

### Шаг 4: Ручной запуск обновления

Попробуйте вручную запустить обновление через API:

```bash
# Замените на ваш Railway URL
curl -X POST https://your-app.railway.app/api/prices/update-all
```

### Шаг 5: Проверьте базу данных

Проверьте, что миграция `add-last-price-update.sql` применена:

```sql
-- В Supabase SQL Editor выполните:
SELECT column_name, data_type 
FROM information_schema.columns 
WHERE table_name = 'sp500_companies' 
AND column_name = 'last_price_update';
```

Должна вернуться строка с `last_price_update`.

## Решение проблем:

### Если планировщик не запускается:

1. Проверьте логи Railway на наличие ошибок
2. Убедитесь, что сервер запущен
3. Перезапустите сервис в Railway

### Если API ключ не работает:

1. Проверьте, что `FMP_API_KEY` добавлен в Railway Environment Variables
2. Убедитесь, что ключ правильный (скопирован полностью, без пробелов)
3. Проверьте статус ключа в FMP Dashboard

### Если цены не обновляются после исправления:

1. Подождите до следующего запланированного обновления (каждый час на 15-й минуте)
2. Или запустите обновление вручную через API
3. Проверьте логи на наличие ошибок

## Мониторинг:

После исправления планировщика, проверьте:

1. **Логи Railway** - должны появляться сообщения о запуске задач
2. **Эндпоинт `/api/prices/last-updated`** - должен показывать актуальное время обновления
3. **База данных** - поле `last_price_update` должно обновляться
